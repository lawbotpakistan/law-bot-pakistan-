<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LawBot Pakistan - AI Legal Assistant | Pakistani Law Expert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <meta name="description" content="Pakistan's most advanced AI legal assistant. Get expert guidance on PPC, CrPC, Constitution 1973, and all Pakistani laws. Monthly subscription Rs. 2,500.">
    <style>
        body {
            box-sizing: border-box;
        }
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        .hero-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #7c3aed 50%, #059669 100%);
        }
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop {
            backdrop-filter: blur(8px);
        }
        .legal-link {
            color: #2563eb;
            text-decoration: underline;
            cursor: pointer;
        }
        .legal-link:hover {
            color: #1d4ed8;
        }
        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        .gradient-text {
            background: linear-gradient(135deg, #1e40af, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .source-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }
        .source-card:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .document-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f9fafb;
        }
        .legal-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            padding: 16px;
            margin: 12px 0;
            border-radius: 8px;
        }
        .case-analysis {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left: 4px solid #3b82f6;
            padding: 16px;
            margin: 12px 0;
            border-radius: 8px;
        }
        .document-generator {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
            padding: 16px;
            margin: 12px 0;
            border-radius: 8px;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-indigo-50 min-h-full">

    <!-- Navigation -->
    <nav class="bg-white/95 backdrop-blur-sm shadow-lg border-b-2 border-blue-500 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="showPage('home')">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                        <span class="text-white font-bold text-xl">‚öñÔ∏è</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold gradient-text">LawBot Pakistan</h1>
                        <p class="text-xs text-gray-500">AI Legal Assistant</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showPage('about')" class="px-4 py-2 text-gray-700 hover:text-blue-600 transition-colors font-medium">About</button>
                    <button onclick="showPage('faq')" class="px-4 py-2 text-gray-700 hover:text-blue-600 transition-colors font-medium">FAQ</button>
                    <div id="navButtons">
                        <button id="loginBtn" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all font-medium shadow-lg">
                            üîê Login
                        </button>
                        <button id="adminBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium" style="display: none;">
                            üëë Admin
                        </button>
                        <button id="logoutBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium" style="display: none;">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Email Verification Notice -->
    <div id="emailVerificationNotice" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 hidden">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    Please check your email and click the verification link to activate your account.
                    <button id="resendVerification" class="font-medium underline hover:text-yellow-600 ml-2">Resend verification email</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div id="debugPanel" class="bg-gray-100 border-b p-2 text-sm text-gray-600" style="display: none;">
        <div class="max-w-7xl mx-auto">
            <span id="debugInfo">Debug: Initializing...</span>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-action">
        <button onclick="handleStartChat()" class="relative bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-full shadow-2xl hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-110">
            <div class="absolute inset-0 rounded-full bg-blue-600 pulse-ring"></div>
            <svg class="w-6 h-6 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
        </button>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="min-h-screen">
        <!-- Hero Section -->
        <div class="hero-gradient text-white py-24 relative overflow-hidden">
            <div class="absolute inset-0 bg-black/10"></div>
            <div class="max-w-6xl mx-auto px-4 text-center relative z-10">
                <h1 class="text-6xl font-bold mb-6 fade-in">Pakistan's Most Advanced<br><span class="text-yellow-300">AI Legal Assistant</span></h1>
                <p class="text-xl mb-8 opacity-90 max-w-4xl mx-auto fade-in leading-relaxed">Get instant, case-specific legal advice with official Pakistani law sources, document generation, and comprehensive legal analysis. Powered by authoritative legal databases and AI technology.</p>
                <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-6 fade-in">
                    <button onclick="handleStartChat()" class="px-10 py-4 bg-white text-blue-600 rounded-xl font-bold hover:bg-gray-100 transition-all text-lg shadow-2xl transform hover:scale-105">
                        üöÄ Start Legal Consultation - Rs. 2,500/month
                    </button>
                    <button onclick="scrollToFeatures()" class="px-8 py-4 border-2 border-white text-white rounded-xl font-bold hover:bg-white hover:text-blue-600 transition-all text-lg">
                        Learn More
                    </button>
                </div>
                <div class="mt-8 flex justify-center items-center space-x-8 text-sm opacity-80">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                        <span>24/7 Available</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span>üìÑ</span>
                        <span>Document Generation</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span>üîó</span>
                        <span>Official Sources</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span>üéØ</span>
                        <span>Case-Specific Advice</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div id="featuresSection" class="py-24 bg-white">
            <div class="max-w-6xl mx-auto px-4">
                <h2 class="text-5xl font-bold text-center mb-4 text-gray-800">Advanced Legal AI Features</h2>
                <p class="text-xl text-center text-gray-600 mb-16 max-w-3xl mx-auto">Professional-grade legal assistance with official sources and document generation</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="text-center p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all card-hover bg-gradient-to-br from-blue-50 to-blue-100">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                            <span class="text-4xl">üéØ</span>
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Case-Specific Legal Advice</h3>
                        <p class="text-gray-600 leading-relaxed">Get tailored legal guidance for your specific situation with detailed case analysis, precedent matching, and strategic recommendations based on your unique circumstances.</p>
                    </div>
                    <div class="text-center p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all card-hover bg-gradient-to-br from-green-50 to-green-100">
                        <div class="bg-gradient-to-r from-green-600 to-blue-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                            <span class="text-4xl">üìÑ</span>
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Legal Document Generation</h3>
                        <p class="text-gray-600 leading-relaxed">Generate professional legal documents including contracts, petitions, applications, notices, and agreements with proper legal formatting and clauses.</p>
                    </div>
                    <div class="text-center p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all card-hover bg-gradient-to-br from-purple-50 to-purple-100">
                        <div class="bg-gradient-to-r from-purple-600 to-pink-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                            <div class="text-4xl">üîó</div>
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Official Pakistani Law Sources</h3>
                        <p class="text-gray-600 leading-relaxed">Direct access to official Pakistani law websites, Supreme Court judgments, High Court decisions, and authoritative legal databases with PDF downloads.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sample Questions Section -->
        <div class="py-24 bg-gradient-to-br from-gray-50 to-blue-50">
            <div class="max-w-6xl mx-auto px-4">
                <h2 class="text-5xl font-bold text-center mb-4 text-gray-800">Try These Sample Questions</h2>
                <p class="text-xl text-center text-gray-600 mb-16">Click any question to see comprehensive legal analysis with sources and documents</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all cursor-pointer card-hover border-l-4 border-red-500" onclick="tryQuestion('I need to file a murder case under Section 302 PPC. My brother was killed in Lahore. What is the complete procedure, required documents, and legal strategy?')">
                        <h3 class="font-bold text-red-600 mb-3 text-lg">üî¥ Criminal Law - Murder Case</h3>
                        <p class="text-gray-700 text-lg">"I need to file a murder case under Section 302 PPC. Complete procedure and strategy?"</p>
                        <div class="mt-4 text-sm text-gray-500">Click to get case-specific advice with documents ‚Üí</div>
                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all cursor-pointer card-hover border-l-4 border-green-500" onclick="tryQuestion('I want to buy a house in Karachi worth 2 crore. Draft a complete sale agreement and tell me about registration procedure, stamp duty, and legal requirements.')">
                        <h3 class="font-bold text-green-600 mb-3 text-lg">üè† Property Law - House Purchase</h3>
                        <p class="text-gray-700 text-lg">"Draft house sale agreement for 2 crore property in Karachi with complete procedure"</p>
                        <div class="mt-4 text-sm text-gray-500">Click to generate documents and get procedure ‚Üí</div>
                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all cursor-pointer card-hover border-l-4 border-purple-500" onclick="tryQuestion('My employer terminated me without notice in Islamabad. I want to file a labor court case. Draft the petition and tell me complete procedure with timeline.')">
                        <h3 class="font-bold text-purple-600 mb-3 text-lg">‚öñÔ∏è Labor Law - Wrongful Termination</h3>
                        <p class="text-gray-700 text-lg">"Wrongful termination case - draft petition and complete procedure"</p>
                        <div class="mt-4 text-sm text-gray-500">Click to get case strategy and documents ‚Üí</div>
                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all cursor-pointer card-hover border-l-4 border-blue-500" onclick="tryQuestion('I want khula from my husband. We have 2 children. Draft the khula petition for family court and tell me about custody and maintenance rights.')">
                        <h3 class="font-bold text-blue-600 mb-3 text-lg">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Law - Khula Case</h3>
                        <p class="text-gray-700 text-lg">"Khula petition with child custody - complete case preparation"</p>
                        <div class="mt-4 text-sm text-gray-500">Click to get family court documents ‚Üí</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Section -->
        <div class="py-24 bg-white">
            <div class="max-w-4xl mx-auto px-4 text-center">
                <h2 class="text-5xl font-bold mb-4 text-gray-800">Professional Legal AI Service</h2>
                <p class="text-xl text-gray-600 mb-16">Complete legal assistance with document generation and official sources</p>
                
                <div class="bg-gradient-to-br from-blue-600 to-purple-600 rounded-3xl p-8 text-white shadow-2xl transform hover:scale-105 transition-all">
                    <div class="bg-white/20 rounded-full px-6 py-2 inline-block mb-6">
                        <span class="font-bold">Professional Grade</span>
                    </div>
                    <h3 class="text-3xl font-bold mb-4">LawBot Pakistan Premium</h3>
                    <div class="text-6xl font-bold mb-2">Rs. 2,500</div>
                    <div class="text-xl opacity-90 mb-8">per month</div>
                    
                    <div class="space-y-4 mb-8 text-left max-w-md mx-auto">
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-green-400 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span>Case-specific legal advice and strategy</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-green-400 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span>Professional legal document generation</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-green-400 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span>Official Pakistani law sources & PDFs</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-green-400 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span>Supreme Court & High Court judgments</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-green-400 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span>24/7 AI assistance with unlimited queries</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-green-400 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <span>WhatsApp support & consultation</span>
                        </div>
                    </div>
                    
                    <button onclick="handleStartChat()" class="bg-white text-blue-600 px-8 py-4 rounded-xl font-bold hover:bg-gray-100 transition-all text-lg shadow-lg transform hover:scale-105">
                        Get Started Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- About Page -->
    <div id="aboutPage" class="min-h-screen py-12" style="display: none;">
        <div class="max-w-4xl mx-auto px-4">
            <div class="bg-white rounded-3xl shadow-2xl p-12">
                <h1 class="text-5xl font-bold text-center mb-8 gradient-text">About LawBot Pakistan</h1>
                
                <div class="prose max-w-none">
                    <div class="mb-12">
                        <h2 class="text-3xl font-bold text-blue-600 mb-6">üéØ Our Mission</h2>
                        <p class="text-gray-700 leading-relaxed text-lg">LawBot Pakistan is the most advanced AI legal assistant designed specifically for Pakistani law. We provide case-specific legal advice, generate professional legal documents, and connect you directly with official Pakistani law sources and Supreme Court judgments.</p>
                    </div>

                    <div class="mb-12">
                        <h2 class="text-3xl font-bold text-blue-600 mb-6">üöÄ Advanced AI Technology</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-blue-50 p-8 rounded-2xl">
                                <h3 class="font-bold text-blue-800 mb-4 text-xl">üéØ Case-Specific Analysis</h3>
                                <p class="text-gray-700">Our AI analyzes your specific legal situation and provides tailored advice, not generic information. Get strategic recommendations based on your unique circumstances.</p>
                            </div>
                            <div class="bg-green-50 p-8 rounded-2xl">
                                <h3 class="font-bold text-green-800 mb-4 text-xl">üìÑ Document Generation</h3>
                                <p class="text-gray-700">Generate professional legal documents including petitions, contracts, applications, and notices with proper legal formatting and clauses.</p>
                            </div>
                            <div class="bg-purple-50 p-8 rounded-2xl">
                                <h3 class="font-bold text-purple-800 mb-4 text-xl">üîó Official Sources</h3>
                                <p class="text-gray-700">Direct integration with Pakistani law websites, Supreme Court database, and official legal repositories with PDF downloads and citations.</p>
                            </div>
                            <div class="bg-yellow-50 p-8 rounded-2xl">
                                <h3 class="font-bold text-yellow-800 mb-4 text-xl">‚ö° Real-time Updates</h3>
                                <p class="text-gray-700">Always up-to-date with latest amendments, new judgments, and legal developments from authoritative Pakistani legal sources.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-12">
                        <h2 class="text-3xl font-bold text-blue-600 mb-6">üìñ Complete Legal Coverage</h2>
                        <div class="bg-gradient-to-br from-gray-50 to-blue-50 p-8 rounded-2xl">
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-6 text-gray-700">
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Pakistan Penal Code (PPC)</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Criminal Procedure Code (CrPC)</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Civil Procedure Code (CPC)</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Constitution of Pakistan 1973</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Supreme Court Judgments</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>High Court Decisions</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Family Laws & Procedures</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Property & Real Estate Law</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Corporate & Business Law</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Labor & Employment Law</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Tax Laws & Regulations</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-600 font-bold">‚úÖ</span>
                                    <span>Banking & Finance Laws</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center bg-gradient-to-r from-blue-600 to-purple-600 text-white p-8 rounded-2xl">
                        <p class="text-xl italic mb-4">Professional legal assistance with case-specific advice and official Pakistani law sources</p>
                        <button onclick="handleStartChat()" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-bold hover:bg-gray-100 transition-all">
                            Start Your Legal Consultation
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ Page -->
    <div id="faqPage" class="min-h-screen py-12" style="display: none;">
        <div class="max-w-4xl mx-auto px-4">
            <div class="bg-white rounded-3xl shadow-2xl p-12">
                <h1 class="text-5xl font-bold text-center mb-8 gradient-text">Frequently Asked Questions</h1>
                
                <div class="space-y-8">
                    <!-- Pricing & Payment -->
                    <div class="bg-blue-50 p-8 rounded-2xl border-l-4 border-blue-500">
                        <h2 class="text-2xl font-bold text-blue-800 mb-6">üí∞ Pricing & Payment</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="font-bold text-blue-700 mb-2">How much does LawBot Pakistan cost?</h3>
                                <p class="text-gray-700">LawBot Pakistan costs Rs. 2,500 per month. This gives you unlimited access to case-specific legal advice, document generation, official law sources, and professional legal assistance.</p>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-blue-700 mb-2">How do I pay for the subscription?</h3>
                                <p class="text-gray-700">Payment is made via SadaPay to <strong>03314619402 (Rabia Hayi)</strong>. You can transfer from any bank or mobile wallet - just ensure it reaches our SadaPay account. After payment, upload the screenshot and your account will be activated within 24 hours.</p>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-blue-700 mb-2">What happens if I don't renew after 30 days?</h3>
                                <p class="text-gray-700">Your access will be automatically blocked after exactly 30 days. Once you make the payment for the next month, your access will be immediately restored with all your chat history intact.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Legal Features -->
                    <div class="bg-green-50 p-8 rounded-2xl border-l-4 border-green-500">
                        <h2 class="text-2xl font-bold text-green-800 mb-6">üìö Legal Features</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="font-bold text-green-700 mb-2">Do you provide case-specific legal advice?</h3>
                                <p class="text-gray-700">Yes! Unlike generic legal information, we analyze your specific situation and provide tailored legal advice, strategy recommendations, and case-specific guidance based on your unique circumstances and Pakistani law.</p>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-green-700 mb-2">Can you generate legal documents?</h3>
                                <p class="text-gray-700">Absolutely! We generate professional legal documents including petitions, contracts, applications, notices, agreements, and other legal papers with proper formatting, clauses, and legal language.</p>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-green-700 mb-2">Do you provide official Pakistani law sources?</h3>
                                <p class="text-gray-700">Yes! We provide direct links to official Pakistani law websites, Supreme Court judgments, High Court decisions, and authoritative legal databases. You get PDF downloads and proper legal citations.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Support -->
                    <div class="bg-purple-50 p-8 rounded-2xl border-l-4 border-purple-500">
                        <h2 class="text-2xl font-bold text-purple-800 mb-6">üõ†Ô∏è Technical Support</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="font-bold text-purple-700 mb-2">How do I get support?</h3>
                                <p class="text-gray-700">For technical issues or complex legal queries, contact our WhatsApp support at <strong>03296564818</strong>. We typically respond within 2-4 hours during business hours.</p>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-purple-700 mb-2">Is my chat history saved?</h3>
                                <p class="text-gray-700">Yes, all your conversations, generated documents, and legal advice are securely saved and accessible anytime during your active subscription. Your data is encrypted and private.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Legal Disclaimers -->
                    <div class="bg-red-50 p-8 rounded-2xl border-l-4 border-red-500">
                        <h2 class="text-2xl font-bold text-red-800 mb-6">‚ö†Ô∏è Important Legal Disclaimers</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="font-bold text-red-700 mb-2">Is LawBot a replacement for a lawyer?</h3>
                                <p class="text-gray-700">LawBot provides professional legal guidance and case-specific advice, but for court representation, complex litigation, or official legal proceedings, we recommend consulting with a qualified Pakistani lawyer.</p>
                            </div>
                            
                            <div>
                                <h3 class="font-bold text-red-700 mb-2">Can I use generated documents in court?</h3>
                                <p class="text-gray-700">Our generated documents are professionally formatted and legally sound. However, for critical court filings, we recommend having them reviewed by a qualified lawyer before submission.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="bg-yellow-50 p-8 rounded-2xl border-l-4 border-yellow-500">
                        <h2 class="text-2xl font-bold text-yellow-800 mb-6">üìû Contact Information</h2>
                        
                        <div class="space-y-4">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">üì±</span>
                                <div>
                                    <p class="font-bold text-yellow-700">WhatsApp Support</p>
                                    <p class="text-gray-700">03296564818</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">üí≥</span>
                                <div>
                                    <p class="font-bold text-yellow-700">SadaPay Payment</p>
                                    <p class="text-gray-700">03314619402 (Rabia Hayi)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-60 modal-backdrop flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 relative shadow-2xl">
            <button id="closeAuth" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                ‚úï
            </button>
            <h2 id="authTitle" class="text-3xl font-bold mb-6 text-center gradient-text">Login to LawBot</h2>
            
            <form id="authForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="authEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
                
                <div id="nameField" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="authName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="authPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
                
                <button type="submit" id="authSubmit" class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all font-medium shadow-lg">
                    Login
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <button id="toggleAuth" class="text-blue-600 hover:text-blue-800 font-medium">
                    Don't have an account? Sign up
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Page -->
    <div id="paymentPage" class="min-h-screen py-12" style="display: none;">
        <div class="max-w-2xl mx-auto px-4">
            <div class="bg-white rounded-3xl shadow-2xl p-8">
                <h1 class="text-4xl font-bold text-center mb-8 gradient-text">Complete Your Subscription</h1>
                
                <div class="bg-gradient-to-br from-blue-600 to-purple-600 text-white p-8 rounded-2xl mb-8">
                    <h2 class="text-2xl font-bold mb-4">LawBot Pakistan Premium</h2>
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-lg">Monthly Subscription</span>
                        <span class="text-4xl font-bold">Rs. 2,500</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <span class="text-green-300">‚úÖ</span>
                            <span>Case-specific legal advice</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-300">‚úÖ</span>
                            <span>Legal document generation</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-300">‚úÖ</span>
                            <span>Official law sources & PDFs</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-300">‚úÖ</span>
                            <span>Supreme Court judgments</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-300">‚úÖ</span>
                            <span>24/7 AI assistance</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-300">‚úÖ</span>
                            <span>WhatsApp support</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-8">
                    <div class="bg-yellow-50 border-2 border-yellow-200 p-6 rounded-2xl">
                        <h3 class="font-bold text-yellow-800 mb-4 text-xl">üí≥ Payment Instructions:</h3>
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-xl border-l-4 border-green-500">
                                <p class="font-bold text-green-700 mb-2">SadaPay Account Details:</p>
                                <p class="text-lg"><strong>Phone:</strong> 03314619402</p>
                                <p class="text-lg"><strong>Name:</strong> Rabia Hayi</p>
                                <p class="text-lg"><strong>Amount:</strong> Rs. 2,500</p>
                            </div>
                            
                            <div class="bg-red-50 p-4 rounded-xl border-l-4 border-red-500">
                                <p class="font-bold text-red-700 mb-2">‚ö†Ô∏è Important:</p>
                                <p class="text-red-600">Only SadaPay transfers accepted. You can send from any bank/wallet, but it must reach our SadaPay account: 03314619402</p>
                            </div>
                            
                            <ol class="list-decimal list-inside space-y-2 text-gray-700 bg-blue-50 p-4 rounded-xl">
                                <li>Send Rs. 2,500 to SadaPay: <strong>03314619402 (Rabia Hayi)</strong></li>
                                <li>You can use any method: JazzCash, EasyPaisa, Bank Transfer, etc.</li>
                                <li>Take a screenshot of the payment confirmation</li>
                                <li>Upload the screenshot below</li>
                                <li>Your account will be activated within 24 hours</li>
                                <li>You'll receive WhatsApp confirmation once approved</li>
                            </ol>
                        </div>
                    </div>

                    <div>
                        <label class="block text-lg font-medium text-gray-700 mb-4">üì∏ Upload Payment Screenshot</label>
                        <input type="file" id="paymentScreenshot" accept="image/*,.pdf" class="w-full px-4 py-4 border-2 border-dashed border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all hover:border-blue-400">
                        <p class="text-sm text-gray-500 mt-2">Supported formats: JPG, PNG, PDF (Max 5MB)</p>
                    </div>

                    <button id="submitPayment" class="w-full py-4 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl hover:from-green-700 hover:to-blue-700 transition-all font-medium text-lg shadow-lg">
                        üì§ Submit Payment Proof
                    </button>

                    <div class="text-center">
                        <button onclick="showPage('home')" class="text-gray-600 hover:text-gray-800 font-medium">
                            ‚Üê Back to Home
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chatPage" class="max-w-6xl mx-auto p-6" style="display: none;">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-green-600 p-8 text-white">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold mb-2">LawBot Pakistan - Professional Legal AI</h2>
                        <p class="opacity-90 text-lg" id="chatSubtitle">Case-Specific Legal Advice ‚Ä¢ Document Generation ‚Ä¢ Official Sources</p>
                    </div>
                    <div class="text-right">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-lg font-medium" id="statusText">Professional AI Ready</span>
                        </div>
                        <p class="text-sm opacity-75 mt-1">Connected to Pakistani Law Database</p>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="h-96 overflow-y-auto p-8 space-y-6 bg-gradient-to-br from-gray-50 to-blue-50">
                <div class="chat-message bg-white p-6 rounded-2xl border-l-4 border-blue-500 shadow-lg">
                    <div class="flex items-start space-x-4">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-full shadow-lg">
                            <span class="text-white text-lg">‚öñÔ∏è</span>
                        </div>
                        <div>
                            <p class="font-bold text-blue-800 mb-2 text-lg">LawBot Pakistan - Professional Legal AI</p>
                            <p class="text-gray-700 leading-relaxed">Welcome to Pakistan's most advanced legal AI assistant! I provide:

üéØ **Case-Specific Legal Advice** - Tailored guidance for your unique situation
üìÑ **Professional Document Generation** - Legal petitions, contracts, applications
üîó **Official Pakistani Law Sources** - Supreme Court judgments, legal PDFs
‚öñÔ∏è **Complete Legal Analysis** - Strategy, precedents, and procedures

**I specialize in:**
‚Ä¢ Criminal Law (PPC, CrPC, FIR, bail applications, murder cases)
‚Ä¢ Civil Law (property disputes, contracts, civil suits)
‚Ä¢ Family Law (khula, divorce, custody, maintenance)
‚Ä¢ Corporate Law (company formation, business agreements)
‚Ä¢ Constitutional Law (fundamental rights, writ petitions)

**Ask me specific questions like:**
"I need to file a murder case - draft the FIR and tell me the complete procedure"
"Generate a house sale agreement for 2 crore property in Karachi"
"My employer terminated me wrongfully - draft a labor court petition"

How can I help with your specific legal matter today?</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="px-8 py-4 bg-white border-t border-b">
                <p class="text-sm text-gray-600 mb-3 font-medium">üöÄ Quick Legal Services:</p>
                <div class="flex flex-wrap gap-3">
                    <button onclick="quickQuestion('I need to file a murder case under Section 302 PPC. Draft the FIR and tell me complete procedure with required documents.')" class="px-4 py-2 bg-red-100 text-red-700 rounded-full text-sm hover:bg-red-200 transition-all font-medium shadow-sm">
                        üî¥ Murder Case Filing
                    </button>
                    <button onclick="quickQuestion('Generate a complete house sale agreement for 2 crore property in Karachi with registration procedure and stamp duty details.')" class="px-4 py-2 bg-green-100 text-green-700 rounded-full text-sm hover:bg-green-200 transition-all font-medium shadow-sm">
                        üè† Property Agreement
                    </button>
                    <button onclick="quickQuestion('Draft a khula petition for family court with child custody and maintenance claims. Include complete procedure and timeline.')" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-full text-sm hover:bg-purple-200 transition-all font-medium shadow-sm">
                        üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Khula Petition
                    </button>
                    <button onclick="quickQuestion('My employer terminated me without notice. Draft a labor court petition and tell me complete procedure with timeline.')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-all font-medium shadow-sm">
                        ‚öñÔ∏è Labor Court Case
                    </button>
                    <button onclick="quickQuestion('I want to start a private limited company in Pakistan. Generate incorporation documents and tell me complete procedure.')" class="px-4 py-2 bg-yellow-100 text-yellow-700 rounded-full text-sm hover:bg-yellow-200 transition-all font-medium shadow-sm">
                        üíº Company Formation
                    </button>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-8 bg-white">
                <div class="flex space-x-4">
                    <input type="text" id="messageInput" placeholder="Describe your specific legal situation - I'll provide case-specific advice and generate documents..." 
                           class="flex-1 px-6 py-4 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-lg">
                    <button id="sendMessage" class="px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-3">üí° Be specific about your situation for tailored legal advice and document generation</p>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="max-w-7xl mx-auto p-6" style="display: none;">
        <div class="bg-white rounded-3xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold gradient-text">Admin Dashboard</h1>
                    <p class="text-gray-600 mt-2">Manage users, payments, and system analytics</p>
                </div>
                <button onclick="refreshAdminData()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all font-medium shadow-lg">
                    üîÑ Refresh Data
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl border-l-4 border-blue-500">
                    <h3 class="text-lg font-bold text-blue-800 mb-2">üë• Total Users</h3>
                    <p id="totalUsers" class="text-4xl font-bold text-blue-600">0</p>
                    <p class="text-sm text-blue-600 mt-1">Registered accounts</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-2xl border-l-4 border-green-500">
                    <h3 class="text-lg font-bold text-green-800 mb-2">‚úÖ Active Subscriptions</h3>
                    <p id="activeSubscriptions" class="text-4xl font-bold text-green-600">0</p>
                    <p class="text-sm text-green-600 mt-1">Paying customers</p>
                </div>
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-2xl border-l-4 border-yellow-500">
                    <h3 class="text-lg font-bold text-yellow-800 mb-2">‚è≥ Pending Payments</h3>
                    <p id="pendingPayments" class="text-4xl font-bold text-yellow-600">0</p>
                    <p class="text-sm text-yellow-600 mt-1">Awaiting approval</p>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-2xl border-l-4 border-purple-500">
                    <h3 class="text-lg font-bold text-purple-800 mb-2">üí∞ Monthly Revenue</h3>
                    <p id="monthlyRevenue" class="text-4xl font-bold text-purple-600">Rs. 0</p>
                    <p class="text-sm text-purple-600 mt-1">Current month</p>
                </div>
            </div>

            <div class="bg-gray-50 rounded-2xl p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">User Management</h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gradient-to-r from-gray-100 to-gray-200">
                                <th class="border border-gray-300 px-6 py-4 text-left font-bold text-gray-700">Email</th>
                                <th class="border border-gray-300 px-6 py-4 text-left font-bold text-gray-700">Name</th>
                                <th class="border border-gray-300 px-6 py-4 text-left font-bold text-gray-700">Status</th>
                                <th class="border border-gray-300 px-6 py-4 text-left font-bold text-gray-700">Joined</th>
                                <th class="border border-gray-300 px-6 py-4 text-left font-bold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-60 modal-backdrop flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 relative shadow-2xl">
            <button id="closeAdmin" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                ‚úï
            </button>
            <h2 class="text-3xl font-bold mb-6 text-center text-red-600">üîê Admin Access</h2>
            
            <form id="adminForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Admin Password</label>
                    <input type="password" id="adminPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all">
                </div>
                
                <button type="submit" class="w-full py-3 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-xl hover:from-red-700 hover:to-red-800 transition-all font-medium shadow-lg">
                    Access Admin Panel
                </button>
            </form>
        </div>
    </div>

    <script>
        // ===== DEFINE ALL FUNCTIONS AT THE VERY TOP =====
        
        // Global variables (declare first)
        let currentUser = null;
        let userProfile = null;
        let currentPage = 'home';
        let isLoginMode = true;
        let supabase = null;
        
        // Core navigation functions
        function handleStartChat() {
            console.log('handleStartChat called');
            if (currentUser && userProfile && userProfile.subscription_status === 'active') {
                showPage('chat');
            } else if (currentUser) {
                showPage('payment');
            } else {
                showAuthModal();
            }
        }

        function scrollToFeatures() {
            console.log('scrollToFeatures called');
            const element = document.getElementById('featuresSection');
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function showPage(page) {
            console.log('showPage called with:', page);
            
            // Hide all pages
            const pages = ['homePage', 'aboutPage', 'faqPage', 'paymentPage', 'chatPage', 'adminPanel'];
            pages.forEach(pageId => {
                const element = document.getElementById(pageId);
                if (element) element.style.display = 'none';
            });

            // Show selected page
            const targetPage = document.getElementById(page + 'Page') || document.getElementById(page);
            if (targetPage) {
                targetPage.style.display = 'block';
            }
            
            currentPage = page;
            updateDebugInfo(`Showing page: ${page}`);
        }

        function tryQuestion(question) {
            console.log('tryQuestion called with:', question);
            if (currentUser && userProfile && userProfile.subscription_status === 'active') {
                showPage('chat');
                setTimeout(() => {
                    const input = document.getElementById('messageInput');
                    if (input) {
                        input.value = question;
                        sendMessage();
                    }
                }, 500);
            } else {
                handleStartChat();
            }
        }

        function quickQuestion(question) {
            console.log('quickQuestion called with:', question);
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = question;
                sendMessage();
            }
        }

        async function refreshAdminData() {
            console.log('refreshAdminData called');
            if (typeof loadAdminData === 'function') {
                await loadAdminData();
            }
        }

        async function approveUser(userId) {
            console.log('approveUser called with:', userId);
            try {
                if (!supabase) {
                    alert('Database not connected');
                    return;
                }
                
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        subscription_status: 'active',
                        subscription_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User approved successfully!');
                if (typeof loadAdminData === 'function') await loadAdminData();
            } catch (error) {
                alert('Error approving user: ' + error.message);
            }
        }

        async function rejectUser(userId) {
            console.log('rejectUser called with:', userId);
            try {
                if (!supabase) {
                    alert('Database not connected');
                    return;
                }
                
                const { error } = await supabase
                    .from('profiles')
                    .update({ subscription_status: 'rejected' })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User rejected successfully!');
                if (typeof loadAdminData === 'function') await loadAdminData();
            } catch (error) {
                alert('Error rejecting user: ' + error.message);
            }
        }

        async function activateUser(userId) {
            console.log('activateUser called with:', userId);
            try {
                if (!supabase) {
                    alert('Database not connected');
                    return;
                }
                
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        subscription_status: 'active',
                        subscription_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User activated successfully!');
                if (typeof loadAdminData === 'function') await loadAdminData();
            } catch (error) {
                alert('Error activating user: ' + error.message);
            }
        }

        async function deactivateUser(userId) {
            console.log('deactivateUser called with:', userId);
            try {
                if (!supabase) {
                    alert('Database not connected');
                    return;
                }
                
                const { error } = await supabase
                    .from('profiles')
                    .update({ subscription_status: 'inactive' })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User deactivated successfully!');
                if (typeof loadAdminData === 'function') await loadAdminData();
            } catch (error) {
                alert('Error deactivating user: ' + error.message);
            }
        }

        function showAuthModal() {
            console.log('showAuthModal called');
            const modal = document.getElementById('authModal');
            if (modal) modal.style.display = 'flex';
        }

        function hideAuthModal() {
            console.log('hideAuthModal called');
            const modal = document.getElementById('authModal');
            if (modal) modal.style.display = 'none';
        }

        function showAdminModal() {
            console.log('showAdminModal called');
            const modal = document.getElementById('adminModal');
            if (modal) modal.style.display = 'flex';
        }

        function hideAdminModal() {
            console.log('hideAdminModal called');
            const modal = document.getElementById('adminModal');
            if (modal) modal.style.display = 'none';
        }

        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.textContent = `Debug: ${message}`;
            }
            console.log('üîç Debug:', message);
        }

        function sendMessage() {
            console.log('sendMessage called');
            const input = document.getElementById('messageInput');
            if (!input) return;
            
            const message = input.value.trim();
            if (!message) return;

            // Check if user has access
            if (!currentUser || !userProfile || userProfile.subscription_status !== 'active') {
                alert('Please subscribe to access the AI legal assistant. Click "Get Started" to subscribe for Rs. 2,500/month.');
                handleStartChat();
                return;
            }

            // Add user message to chat
            addMessage('You', message, 'user');
            input.value = '';

            // Add bot response (simplified for now)
            setTimeout(() => {
                addMessage('LawBot Pakistan', 'Thank you for your question. This is a test response. The full AI integration will be completed soon.', 'bot');
            }, 1000);
        }

        function addMessage(sender, message, type) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="bg-blue-600 text-white p-6 rounded-2xl ml-12 shadow-lg">
                        <div class="flex items-start space-x-4">
                            <div class="bg-white/20 p-3 rounded-full">
                                <span class="text-lg">üë§</span>
                            </div>
                            <div>
                                <p class="font-bold mb-2">${sender}</p>
                                <p class="leading-relaxed">${message}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-blue-500 shadow-lg mr-12">
                        <div class="flex items-start space-x-4">
                            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-full shadow-lg">
                                <span class="text-white text-lg">‚öñÔ∏è</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-blue-800 mb-2 text-lg">${sender}</p>
                                <div class="text-gray-700 leading-relaxed">${message}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Expose ALL functions to global window object IMMEDIATELY
        window.handleStartChat = handleStartChat;
        window.scrollToFeatures = scrollToFeatures;
        window.showPage = showPage;
        window.tryQuestion = tryQuestion;
        window.quickQuestion = quickQuestion;
        window.refreshAdminData = refreshAdminData;
        window.approveUser = approveUser;
        window.rejectUser = rejectUser;
        window.activateUser = activateUser;
        window.deactivateUser = deactivateUser;
        window.showAuthModal = showAuthModal;
        window.hideAuthModal = hideAuthModal;
        window.showAdminModal = showAdminModal;
        window.hideAdminModal = hideAdminModal;
        window.sendMessage = sendMessage;

        console.log('‚úÖ All functions defined and exposed to window object');

        // ===== INITIALIZE SUPABASE =====
        const supabaseUrl = 'https://iyakobcjerlwvcjvttwh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5YWtvYmNqZXJsd3ZjanZ0dHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MzU3OTEsImV4cCI6MjA3NTUxMTc5MX0.IwGfznq8fXhm5QEC7qAhndgKnDX2oWzxODEAmXyx7G8';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true
                }
            });
            console.log('‚úÖ Supabase initialized successfully');
            updateDebugInfo('Supabase connected successfully');
        } catch (error) {
            console.error('‚ùå Supabase initialization failed:', error);
            updateDebugInfo('Database connection failed: ' + error.message);
        }

        // Enhanced API Key Management with Multiple Providers
        const API_KEYS = {
            gemini: [
                'AIzaSyDsddoK5OU0qyhQK8AColdDpQXWnznOS3M',
                'AIzaSyBvZKHO-qJ8rF3mN2pL4xW9cE7dT6uV8sA',
                'AIzaSyCxD2wE5fG8hI9jK0lM3nO4pQ6rS7tU9vB'
            ],
            openai: 'sk-proj-your-openai-key-here',
            claude: 'sk-ant-your-claude-key-here'
        };

        let currentGeminiKeyIndex = 0;
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

        // Pakistani Law Sources Database
        const PAKISTANI_LAW_SOURCES = {
            'supreme_court': {
                name: 'Supreme Court of Pakistan',
                url: 'https://www.supremecourt.gov.pk',
                search_url: 'https://www.supremecourt.gov.pk/judgments-search',
                type: 'judgments'
            },
            'lahore_high_court': {
                name: 'Lahore High Court',
                url: 'https://www.lhc.gov.pk',
                search_url: 'https://www.lhc.gov.pk/judgments',
                type: 'judgments'
            },
            'sindh_high_court': {
                name: 'Sindh High Court',
                url: 'https://www.shc.gov.pk',
                search_url: 'https://www.shc.gov.pk/judgments',
                type: 'judgments'
            },
            'pakistan_code': {
                name: 'Pakistan Code',
                url: 'http://www.pakistancode.gov.pk',
                search_url: 'http://www.pakistancode.gov.pk/english/UY2FqaJw1-apaUY2Fqa-sg-jjjjjjjjjG',
                type: 'legislation'
            },
            'national_assembly': {
                name: 'National Assembly of Pakistan',
                url: 'https://www.na.gov.pk',
                search_url: 'https://www.na.gov.pk/en/acts.php',
                type: 'legislation'
            },
            'law_justice_commission': {
                name: 'Law and Justice Commission',
                url: 'https://ljcp.gov.pk',
                search_url: 'https://ljcp.gov.pk/Menu/Reports',
                type: 'reports'
            }
        };

        // Legal Document Templates
        const LEGAL_DOCUMENT_TEMPLATES = {
            'fir': {
                title: 'First Information Report (FIR)',
                sections: ['complainant_details', 'incident_details', 'accused_details', 'witnesses', 'prayer']
            },
            'bail_application': {
                title: 'Bail Application',
                sections: ['applicant_details', 'case_details', 'grounds_for_bail', 'precedents', 'prayer']
            },
            'civil_suit': {
                title: 'Civil Suit',
                sections: ['plaintiff_details', 'defendant_details', 'facts', 'cause_of_action', 'relief_sought']
            },
            'khula_petition': {
                title: 'Khula Petition',
                sections: ['petitioner_details', 'respondent_details', 'marriage_details', 'grounds_for_khula', 'prayer']
            },
            'sale_agreement': {
                title: 'Sale Agreement',
                sections: ['vendor_details', 'purchaser_details', 'property_details', 'consideration', 'terms_conditions']
            },
            'labor_petition': {
                title: 'Labor Court Petition',
                sections: ['petitioner_details', 'respondent_details', 'employment_details', 'grievance', 'relief_sought']
            }
        };

        // Application state
        let currentPage = 'home';
        let currentUser = null;
        let userProfile = null;
        let isLoginMode = true;
        
        // Admin password
        const ADMIN_PASSWORD = 'R@@him9374';
        
        // Debug functions
        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.textContent = `Debug: ${message}`;
            }
            console.log('üîç Debug:', message);
        }

        // Enhanced Supabase troubleshooting function
        async function checkSupabaseStatus() {
            updateDebugInfo('Testing Supabase connection...');
            
            try {
                // Test 1: Basic connection test
                console.log('üîç Testing basic Supabase connection...');
                const { data: testData, error: testError } = await supabase
                    .from('profiles')
                    .select('count')
                    .limit(1);
                
                if (testError) {
                    console.error('‚ùå Basic connection failed:', testError);
                    
                    // Analyze specific error types
                    if (testError.code === 'PGRST116') {
                        updateDebugInfo('Table "profiles" does not exist - needs database setup');
                        showDatabaseSetupInstructions();
                        return false;
                    } else if (testError.code === '42P07') {
                        updateDebugInfo('Table exists but may need RLS policies - checking setup');
                        showDatabaseSetupInstructions(); // Will handle existing tables safely
                        return false;
                    } else if (testError.message.includes('permission denied') || testError.message.includes('RLS')) {
                        updateDebugInfo('Permission denied - RLS policy issue');
                        showRLSInstructions();
                        return false;
                    } else if (testError.message.includes('JWT') || testError.message.includes('token')) {
                        updateDebugInfo('Authentication token issue');
                        showAuthTokenInstructions();
                        return false;
                    } else if (testError.code === '42501') {
                        updateDebugInfo('Insufficient privileges - RLS policy needed');
                        showRLSInstructions();
                        return false;
                    } else {
                        updateDebugInfo(`Database error (${testError.code}): ${testError.message}`);
                        console.log('Full error details:', testError);
                        
                        // Show appropriate instructions based on error
                        if (testError.message.includes('relation') || testError.message.includes('table')) {
                            showDatabaseSetupInstructions();
                        } else {
                            showRLSInstructions();
                        }
                        return false;
                    }
                }
                
                // Test 2: Auth service test
                console.log('üîç Testing Supabase Auth service...');
                const { data: { session }, error: authError } = await supabase.auth.getSession();
                
                if (authError) {
                    console.error('‚ùå Auth service error:', authError);
                    updateDebugInfo(`Auth error: ${authError.message}`);
                } else {
                    console.log('‚úÖ Auth service working');
                    updateDebugInfo('Auth service operational');
                }
                
                // Test 3: Storage test (optional)
                console.log('üîç Testing Supabase Storage...');
                const { data: buckets, error: storageError } = await supabase.storage.listBuckets();
                
                if (storageError) {
                    console.warn('‚ö†Ô∏è Storage test failed:', storageError);
                    updateDebugInfo('Storage may need setup, but core functions work');
                } else {
                    console.log('‚úÖ Storage service working');
                }
                
                console.log('‚úÖ All Supabase tests passed');
                updateDebugInfo('Supabase fully operational');
                return true;
                
            } catch (error) {
                console.error('‚ùå Supabase connection test failed:', error);
                updateDebugInfo(`Connection failed: ${error.message}`);
                
                // Check if it's a network issue
                if (error.message.includes('fetch')) {
                    updateDebugInfo('Network connectivity issue detected');
                    alert('Network Error: Unable to connect to database.\n\nPlease check your internet connection and try again.');
                } else {
                    alert(`Database Connection Error: ${error.message}\n\nContact support: WhatsApp 03296564818`);
                }
                
                return false;
            }
        }

        function showDatabaseSetupInstructions() {
            const instructions = `
üîß SUPABASE DATABASE SETUP - STEP BY STEP

You have a "users" table conflict. Follow these exact steps:

**STEP 1: Check what exists (REQUIRED FIRST)**
Go to Supabase Dashboard ‚Üí SQL Editor and run:

SELECT table_name, table_schema 
FROM information_schema.tables 
WHERE table_name = 'users';

**STEP 2A: If you see existing "users" table - RENAME IT**
-- Safely rename the existing table to avoid conflicts
ALTER TABLE public.users RENAME TO users_old_backup;

**STEP 2B: Create NEW profile table (RECOMMENDED)**
-- Create a clean profile table that references auth.users
CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT NOT NULL,
  name TEXT,
  subscription_status TEXT DEFAULT 'pending',
  payment_screenshot_url TEXT,
  subscription_expires_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- Create policy
CREATE POLICY "Users can access own profile" ON profiles
  FOR ALL USING (auth.uid() = id);

**STEP 3: Create other tables**
-- Chat history table
CREATE TABLE chat_history (
  id SERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  message TEXT NOT NULL,
  response TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

ALTER TABLE chat_history ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can access own chat" ON chat_history
  FOR ALL USING (auth.uid() = user_id);

-- Payments table
CREATE TABLE payments (
  id SERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  amount INTEGER NOT NULL,
  screenshot_url TEXT,
  status TEXT DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT NOW()
);

ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can access own payments" ON payments
  FOR ALL USING (auth.uid() = user_id);

**STEP 4: Create Storage Bucket**
- Go to Storage ‚Üí Create bucket: "payment-screenshots"
- Make it public

**STEP 5: Update the code**
After setup, I'll update the code to use "profiles" instead of "users"

Run STEP 1 first and tell me what you see!
            `;
            
            console.log(instructions);
            alert(instructions);
        }

        function showRLSInstructions() {
            const instructions = `
üîí ROW LEVEL SECURITY (RLS) ISSUE

Your database tables exist but RLS policies need setup:

1. Go to Supabase Dashboard ‚Üí Authentication ‚Üí Policies
2. For each table (profiles, chat_history, payments), add policies:

For 'profiles' table:
- Policy name: "Users can access own data"
- Policy: auth.uid() = id
- Operations: All

For 'chat_history' table:
- Policy name: "Users can access own chat"
- Policy: auth.uid() = user_id
- Operations: All

For 'payments' table:
- Policy name: "Users can access own payments"  
- Policy: auth.uid() = user_id
- Operations: All

3. Refresh this page after setup
            `;
            
            console.log(instructions);
            alert(instructions);
        }

        function showAuthTokenInstructions() {
            const instructions = `
üîë AUTHENTICATION TOKEN ISSUE

There's an issue with your Supabase API key:

1. Go to Supabase Dashboard ‚Üí Settings ‚Üí API
2. Copy the "anon public" key (NOT service_role)
3. Make sure the key starts with "eyJ..."
4. Update the key in the code
5. Refresh this page

Current key status: ${supabaseKey ? 'Present' : 'Missing'}

Contact support if you need help: WhatsApp 03296564818
            `;
            
            console.log(instructions);
            alert(instructions);
        }

        function toggleDebugPanel() {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
        }

        // Define ALL functions in global scope FIRST before any other code
        function handleStartChat() {
            if (currentUser && userProfile && userProfile.subscription_status === 'active') {
                showPage('chat');
            } else if (currentUser) {
                // User is logged in but not subscribed
                showPage('payment');
            } else {
                // User not logged in
                showAuthModal();
            }
        }

        function scrollToFeatures() {
            document.getElementById('featuresSection').scrollIntoView({ behavior: 'smooth' });
        }

        function showPage(page) {
            // Hide all pages
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('aboutPage').style.display = 'none';
            document.getElementById('faqPage').style.display = 'none';
            document.getElementById('paymentPage').style.display = 'none';
            document.getElementById('chatPage').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';

            // Show selected page
            if (page === 'home') {
                document.getElementById('homePage').style.display = 'block';
            } else if (page === 'about') {
                document.getElementById('aboutPage').style.display = 'block';
            } else if (page === 'faq') {
                document.getElementById('faqPage').style.display = 'block';
            } else if (page === 'payment') {
                document.getElementById('paymentPage').style.display = 'block';
            } else if (page === 'chat') {
                document.getElementById('chatPage').style.display = 'block';
            } else if (page === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
            }
            
            currentPage = page;
            updateDebugInfo(`Showing page: ${page}`);
        }

        function tryQuestion(question) {
            console.log('Try question clicked:', question);
            if (currentUser && userProfile && userProfile.subscription_status === 'active') {
                showPage('chat');
                setTimeout(() => {
                    document.getElementById('messageInput').value = question;
                    sendMessage();
                }, 500);
            } else {
                handleStartChat();
            }
        }

        function quickQuestion(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        async function refreshAdminData() {
            await loadAdminData();
        }

        async function approveUser(userId) {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        subscription_status: 'active',
                        subscription_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User approved successfully!');
                await loadAdminData();
            } catch (error) {
                alert('Error approving user: ' + error.message);
            }
        }

        async function rejectUser(userId) {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ subscription_status: 'rejected' })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User rejected successfully!');
                await loadAdminData();
            } catch (error) {
                alert('Error rejecting user: ' + error.message);
            }
        }

        async function activateUser(userId) {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        subscription_status: 'active',
                        subscription_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User activated successfully!');
                await loadAdminData();
            } catch (error) {
                alert('Error activating user: ' + error.message);
            }
        }

        async function deactivateUser(userId) {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ subscription_status: 'inactive' })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User deactivated successfully!');
                await loadAdminData();
            } catch (error) {
                alert('Error deactivating user: ' + error.message);
            }
        }

        // Expose ALL functions to global window object IMMEDIATELY
        window.tryQuestion = tryQuestion;
        window.handleStartChat = handleStartChat;
        window.showPage = showPage;
        window.scrollToFeatures = scrollToFeatures;
        window.quickQuestion = quickQuestion;
        window.refreshAdminData = refreshAdminData;
        window.approveUser = approveUser;
        window.rejectUser = rejectUser;
        window.activateUser = activateUser;
        window.deactivateUser = deactivateUser;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            updateDebugInfo('Application starting...');
            
            // Test Supabase connection first
            const isConnected = await checkSupabaseStatus();
            
            if (isConnected) {
                setupEventListeners();
                checkAuthState();
                showPage('home');
                console.log('üîë API Keys loaded:', API_KEYS.gemini.length, 'Gemini keys available');
            } else {
                // Show error state
                showPage('home');
                updateDebugInfo('Application started with database issues');
            }
            
            // Show debug panel for testing
            document.getElementById('debugPanel').style.display = 'block';
        });

        function setupEventListeners() {
            updateDebugInfo('Setting up event listeners...');
            
            // Navigation
            document.getElementById('loginBtn').addEventListener('click', showAuthModal);
            document.getElementById('adminBtn').addEventListener('click', showAdminModal);
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Auth modal
            document.getElementById('closeAuth').addEventListener('click', hideAuthModal);
            document.getElementById('toggleAuth').addEventListener('click', toggleAuthMode);
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            document.getElementById('resendVerification').addEventListener('click', resendVerificationEmail);

            // Admin modal
            document.getElementById('closeAdmin').addEventListener('click', hideAdminModal);
            document.getElementById('adminForm').addEventListener('submit', handleAdminLogin);

            // Payment
            document.getElementById('submitPayment').addEventListener('click', handlePaymentSubmission);

            // Chat functionality
            document.getElementById('sendMessage').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Close modals on backdrop click
            document.getElementById('authModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideAuthModal();
            });
            document.getElementById('adminModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideAdminModal();
            });

            // Listen for auth state changes
            supabase.auth.onAuthStateChange((event, session) => {
                updateDebugInfo(`Auth state changed: ${event}`);
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    updateDebugInfo(`User signed in: ${session.user.email}`);
                    loadUserProfile();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    userProfile = null;
                    updateDebugInfo('User signed out');
                    showPage('home');
                }
                updateUI();
            });
        }

        async function checkAuthState() {
            updateDebugInfo('Checking authentication state...');
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    updateDebugInfo(`Found existing session: ${session.user.email}`);
                    await loadUserProfile();
                } else {
                    updateDebugInfo('No existing session found');
                }
                updateUI();
            } catch (error) {
                console.error('Error checking auth state:', error);
                updateDebugInfo('Error checking auth: ' + error.message);
            }
        }

        async function createUserProfile(user, name) {
            updateDebugInfo('Creating user profile...');
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .insert([{
                        id: user.id,
                        email: user.email,
                        name: name,
                        subscription_status: 'pending',
                        created_at: new Date().toISOString()
                    }]);

                if (error && !error.message.includes('duplicate key')) {
                    console.error('Error creating profile:', error);
                    updateDebugInfo('Error creating profile: ' + error.message);
                } else {
                    updateDebugInfo('User profile created successfully');
                }
            } catch (error) {
                console.error('Error creating user profile:', error);
                updateDebugInfo('Profile creation failed: ' + error.message);
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            
            updateDebugInfo('Loading user profile...');
            try {
                let { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error && error.code === 'PGRST116') {
                    // User profile doesn't exist, create it
                    updateDebugInfo('Profile not found, creating new profile...');
                    await createUserProfile(currentUser, currentUser.user_metadata?.name || currentUser.email.split('@')[0]);
                    
                    // Try to load again
                    const { data: newData, error: newError } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (newError) {
                        console.error('Error loading new profile:', newError);
                        updateDebugInfo('Error loading new profile: ' + newError.message);
                        return;
                    }
                    
                    data = newData;
                } else if (error) {
                    console.error('Error loading profile:', error);
                    updateDebugInfo('Error loading profile: ' + error.message);
                    return;
                }
                
                userProfile = data;
                updateDebugInfo(`Profile loaded: ${data.email} - Status: ${data.subscription_status}`);
                
                // Check email verification (disabled for development)
                if (!currentUser.email_confirmed_at) {
                    updateDebugInfo('Email not verified - allowing access for development');
                    // showEmailVerificationNotice();
                    // return;
                }
                
                // Route based on subscription status
                if (data.subscription_status === 'active') {
                    updateDebugInfo('User has active subscription, loading chat');
                    showPage('chat');
                    await loadChatHistory();
                } else if (data.subscription_status === 'pending_verification') {
                    updateDebugInfo('Payment pending verification');
                    alert('Your payment is being verified. You will be notified within 24 hours once approved.');
                    showPage('home');
                } else {
                    updateDebugInfo('User needs to pay, showing payment page');
                    showPage('payment');
                }
                
            } catch (error) {
                console.error('Error loading profile:', error);
                updateDebugInfo('Profile loading failed: ' + error.message);
            }
        }

        function showEmailVerificationNotice() {
            document.getElementById('emailVerificationNotice').classList.remove('hidden');
            showPage('home');
        }

        async function resendVerificationEmail() {
            try {
                const { error } = await supabase.auth.resend({
                    type: 'signup',
                    email: currentUser.email
                });

                if (error) throw error;
                
                alert('Verification email sent! Please check your inbox.');
                updateDebugInfo('Verification email resent');
            } catch (error) {
                console.error('Error resending verification:', error);
                alert('Error sending verification email: ' + error.message);
                updateDebugInfo('Error resending verification: ' + error.message);
            }
        }

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        function showAdminModal() {
            document.getElementById('adminModal').style.display = 'flex';
        }

        function hideAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('authTitle');
            const submitBtn = document.getElementById('authSubmit');
            const toggleBtn = document.getElementById('toggleAuth');
            const nameField = document.getElementById('nameField');

            if (isLoginMode) {
                title.textContent = 'Login to LawBot';
                submitBtn.textContent = 'Login';
                toggleBtn.textContent = "Don't have an account? Sign up";
                nameField.style.display = 'none';
            } else {
                title.textContent = 'Sign Up for LawBot';
                submitBtn.textContent = 'Sign Up';
                toggleBtn.textContent = 'Already have an account? Login';
                nameField.style.display = 'block';
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const name = document.getElementById('authName').value.trim();

            // Basic validation
            if (!email || !password) {
                alert('Please fill in all required fields');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            updateDebugInfo(`Attempting ${isLoginMode ? 'login' : 'signup'} for: ${email}`);

            try {
                if (isLoginMode) {
                    console.log('Attempting login for:', email);
                    
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) {
                        console.error('Login error:', error);
                        updateDebugInfo('Login failed: ' + error.message);
                        throw error;
                    }
                    
                    console.log('Login successful:', data);
                    updateDebugInfo('Login successful');
                    hideAuthModal();
                    
                } else {
                    console.log('Attempting signup for:', email);
                    
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                name: name || email.split('@')[0]
                            }
                        }
                    });

                    if (error) {
                        console.error('Signup error:', error);
                        updateDebugInfo('Signup failed: ' + error.message);
                        throw error;
                    }
                    
                    console.log('Signup successful:', data);
                    updateDebugInfo('Signup successful');
                    
                    // Create user profile in database
                    if (data.user) {
                        await createUserProfile(data.user, name || email.split('@')[0]);
                    }
                    
                    hideAuthModal();
                    alert('Account created successfully! Please check your email and click the verification link to activate your account.');
                }
                
            } catch (error) {
                console.error('Auth error:', error);
                let errorMessage = 'Authentication failed';
                
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'Invalid email or password. Please check your credentials.';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = 'Please check your email and click the verification link first.';
                } else if (error.message.includes('User already registered')) {
                    errorMessage = 'This email is already registered. Please try logging in instead.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
                updateDebugInfo('Auth error: ' + errorMessage);
            }
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            
            const password = document.getElementById('adminPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                hideAdminModal();
                showPage('admin');
                await loadAdminData();
                updateDebugInfo('Admin access granted');
            } else {
                alert('Invalid admin password!');
                updateDebugInfo('Invalid admin password attempt');
            }
        }

        async function handlePaymentSubmission() {
            const fileInput = document.getElementById('paymentScreenshot');
            
            if (!fileInput.files[0]) {
                alert('Please upload a payment screenshot!');
                return;
            }

            updateDebugInfo('Submitting payment proof...');

            try {
                const file = fileInput.files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;

                // Upload file to Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('payment-screenshots')
                    .upload(fileName, file);

                if (uploadError) {
                    updateDebugInfo('File upload failed: ' + uploadError.message);
                    throw uploadError;
                }

                // Create payment record
                const { error: paymentError } = await supabase
                    .from('payments')
                    .insert([{
                        user_id: currentUser.id,
                        amount: 2500,
                        screenshot_url: uploadData.path,
                        status: 'pending'
                    }]);

                if (paymentError) {
                    updateDebugInfo('Payment record creation failed: ' + paymentError.message);
                    throw paymentError;
                }

                // Update user status
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ 
                        subscription_status: 'pending_verification',
                        payment_screenshot_url: uploadData.path
                    })
                    .eq('id', currentUser.id);

                if (updateError) {
                    updateDebugInfo('User status update failed: ' + updateError.message);
                    throw updateError;
                }

                updateDebugInfo('Payment proof submitted successfully');
                alert('Payment proof submitted successfully! Your account will be activated within 24 hours. You will receive WhatsApp confirmation once approved.');
                showPage('home');
                
            } catch (error) {
                console.error('Payment submission error:', error);
                alert('Error submitting payment: ' + error.message);
                updateDebugInfo('Payment submission error: ' + error.message);
            }
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                document.getElementById('emailVerificationNotice').classList.add('hidden');
                updateDebugInfo('User logged out');
            } catch (error) {
                console.error('Logout error:', error);
                updateDebugInfo('Logout error: ' + error.message);
            }
        }

        function updateUI() {
            const loginBtn = document.getElementById('loginBtn');
            const adminBtn = document.getElementById('adminBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (currentUser) {
                loginBtn.style.display = 'none';
                adminBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'inline-block';
                logoutBtn.textContent = `üö™ ${userProfile?.name || currentUser.email.split('@')[0]}`;
            } else {
                loginBtn.style.display = 'inline-block';
                adminBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
            }

            // Update chat subtitle based on user status
            const chatSubtitle = document.getElementById('chatSubtitle');
            const statusText = document.getElementById('statusText');
            
            if (currentUser && userProfile && userProfile.subscription_status === 'active') {
                chatSubtitle.textContent = 'Case-Specific Legal Advice ‚Ä¢ Document Generation ‚Ä¢ Official Sources';
                statusText.textContent = 'Professional AI Ready';
            } else {
                chatSubtitle.textContent = 'Case-Specific Legal Advice ‚Ä¢ Document Generation ‚Ä¢ Official Sources';
                statusText.textContent = 'Ready to Help';
            }
        }

        function handleStartChat() {
            if (currentUser && userProfile && userProfile.subscription_status === 'active') {
                showPage('chat');
            } else if (currentUser) {
                // User is logged in but not subscribed
                showPage('payment');
            } else {
                // User not logged in
                showAuthModal();
            }
        }

        function scrollToFeatures() {
            document.getElementById('featuresSection').scrollIntoView({ behavior: 'smooth' });
        }

        function showPage(page) {
            // Hide all pages
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('aboutPage').style.display = 'none';
            document.getElementById('faqPage').style.display = 'none';
            document.getElementById('paymentPage').style.display = 'none';
            document.getElementById('chatPage').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';

            // Show selected page
            if (page === 'home') {
                document.getElementById('homePage').style.display = 'block';
            } else if (page === 'about') {
                document.getElementById('aboutPage').style.display = 'block';
            } else if (page === 'faq') {
                document.getElementById('faqPage').style.display = 'block';
            } else if (page === 'payment') {
                document.getElementById('paymentPage').style.display = 'block';
            } else if (page === 'chat') {
                document.getElementById('chatPage').style.display = 'block';
            } else if (page === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
            }
            
            currentPage = page;
            updateDebugInfo(`Showing page: ${page}`);
        }

        function tryQuestion(question) {
            console.log('Try question clicked:', question);
            if (currentUser && userProfile && userProfile.subscription_status === 'active') {
                showPage('chat');
                setTimeout(() => {
                    document.getElementById('messageInput').value = question;
                    sendMessage();
                }, 500);
            } else {
                handleStartChat();
            }
        }

        // Expose ALL functions to global window object for HTML onclick handlers
        window.tryQuestion = tryQuestion;
        window.handleStartChat = handleStartChat;
        window.showPage = showPage;
        window.scrollToFeatures = scrollToFeatures;
        window.quickQuestion = quickQuestion;
        window.refreshAdminData = refreshAdminData;
        window.approveUser = approveUser;
        window.rejectUser = rejectUser;
        window.activateUser = activateUser;
        window.deactivateUser = deactivateUser;

        function quickQuestion(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        async function loadAdminData() {
            updateDebugInfo('Loading admin data...');
            try {
                // Load users
                const { data: users, error: usersError } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (usersError) throw usersError;

                // Update statistics
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('activeSubscriptions').textContent = users.filter(u => u.subscription_status === 'active').length;
                document.getElementById('pendingPayments').textContent = users.filter(u => u.subscription_status === 'pending_verification').length;
                document.getElementById('monthlyRevenue').textContent = `Rs. ${users.filter(u => u.subscription_status === 'active').length * 2500}`;

                // Populate users table
                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border border-gray-300 px-6 py-4">${user.email}</td>
                        <td class="border border-gray-300 px-6 py-4">${user.name || 'N/A'}</td>
                        <td class="border border-gray-300 px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${
                                user.subscription_status === 'active' ? 'bg-green-100 text-green-800' :
                                user.subscription_status === 'pending_verification' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }">
                                ${user.subscription_status}
                            </span>
                        </td>
                        <td class="border border-gray-300 px-6 py-4">${new Date(user.created_at).toLocaleDateString()}</td>
                        <td class="border border-gray-300 px-6 py-4">
                            ${user.subscription_status === 'pending_verification' ? 
                                `<button onclick="approveUser('${user.id}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 mr-2">Approve</button>
                                 <button onclick="rejectUser('${user.id}')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>` :
                                user.subscription_status === 'active' ?
                                `<button onclick="deactivateUser('${user.id}')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Deactivate</button>` :
                                `<button onclick="activateUser('${user.id}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Activate</button>`
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                updateDebugInfo('Admin data loaded successfully');
            } catch (error) {
                console.error('Error loading admin data:', error);
                updateDebugInfo('Admin data loading failed: ' + error.message);
            }
        }

        async function refreshAdminData() {
            await loadAdminData();
        }

        async function approveUser(userId) {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        subscription_status: 'active',
                        subscription_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User approved successfully!');
                await loadAdminData();
            } catch (error) {
                alert('Error approving user: ' + error.message);
            }
        }

        async function rejectUser(userId) {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ subscription_status: 'rejected' })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User rejected successfully!');
                await loadAdminData();
            } catch (error) {
                alert('Error rejecting user: ' + error.message);
            }
        }

        async function activateUser(userId) {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        subscription_status: 'active',
                        subscription_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User activated successfully!');
                await loadAdminData();
            } catch (error) {
                alert('Error activating user: ' + error.message);
            }
        }

        async function deactivateUser(userId) {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ subscription_status: 'inactive' })
                    .eq('id', userId);

                if (error) throw error;
                
                alert('User deactivated successfully!');
                await loadAdminData();
            } catch (error) {
                alert('Error deactivating user: ' + error.message);
            }
        }

        async function loadChatHistory() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('chat_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: true })
                    .limit(10);

                if (error) throw error;

                // Clear existing messages except welcome
                const chatMessages = document.getElementById('chatMessages');
                const welcomeMessage = chatMessages.querySelector('.chat-message');
                chatMessages.innerHTML = '';
                chatMessages.appendChild(welcomeMessage);

                // Add chat history
                data.forEach(chat => {
                    addMessage('You', chat.message, 'user');
                    addMessage('LawBot Pakistan', chat.response, 'bot');
                });

            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        async function saveChatMessage(message, response) {
            if (!currentUser) return;
            
            try {
                const { error } = await supabase
                    .from('chat_history')
                    .insert([{
                        user_id: currentUser.id,
                        message: message,
                        response: response
                    }]);

                if (error) throw error;
            } catch (error) {
                console.error('Error saving chat:', error);
            }
        }

        function addMessage(sender, message, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="bg-blue-600 text-white p-6 rounded-2xl ml-12 shadow-lg">
                        <div class="flex items-start space-x-4">
                            <div class="bg-white/20 p-3 rounded-full">
                                <span class="text-lg">üë§</span>
                            </div>
                            <div>
                                <p class="font-bold mb-2">${sender}</p>
                                <p class="leading-relaxed">${message}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-blue-500 shadow-lg mr-12">
                        <div class="flex items-start space-x-4">
                            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-full shadow-lg">
                                <span class="text-white text-lg">‚öñÔ∏è</span>
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-blue-800 mb-2 text-lg">${sender}</p>
                                <div class="text-gray-700 leading-relaxed">${formatLegalResponse(message)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message typing-indicator';
            typingDiv.id = 'typing-' + Date.now();
            
            typingDiv.innerHTML = `
                <div class="bg-white p-6 rounded-2xl border-l-4 border-blue-500 shadow-lg mr-12">
                    <div class="flex items-start space-x-4">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-full shadow-lg">
                            <span class="text-white text-lg">‚öñÔ∏è</span>
                        </div>
                        <div>
                            <p class="font-bold text-blue-800 mb-2">LawBot Pakistan</p>
                            <div class="flex items-center space-x-2">
                                <div class="loading-spinner"></div>
                                <p class="text-gray-600">Analyzing your legal query and generating case-specific advice...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return typingDiv.id;
        }

        function removeTypingIndicator(typingId) {
            const typingDiv = document.getElementById(typingId);
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function formatLegalResponse(response) {
            // Convert markdown-style formatting to HTML
            return response
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>')
                .replace(/(<p><\/p>)/g, '');
        }

        // Expose ALL functions to global window object for HTML onclick handlers
        window.tryQuestion = tryQuestion;
        window.handleStartChat = handleStartChat;
        window.showPage = showPage;
        window.scrollToFeatures = scrollToFeatures;
        window.quickQuestion = quickQuestion;
        window.refreshAdminData = refreshAdminData;
        window.approveUser = approveUser;
        window.rejectUser = rejectUser;
        window.activateUser = activateUser;
        window.deactivateUser = deactivateUser;

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Check if user has access
            if (!currentUser || !userProfile || userProfile.subscription_status !== 'active') {
                alert('Please subscribe to access the AI legal assistant. Click "Get Started" to subscribe for Rs. 2,500/month.');
                handleStartChat();
                return;
            }

            updateDebugInfo('Sending message to AI...');

            // Add user message
            addMessage('You', message, 'user');
            input.value = '';

            // Show typing indicator
            const typingId = addTypingIndicator();

            try {
                // Get AI response using enhanced system
                const response = await getEnhancedAIResponse(message);
                
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                // Add AI response
                addMessage('LawBot Pakistan', response, 'bot');
                
                // Save to chat history
                await saveChatMessage(message, response);
                
                updateDebugInfo('Message sent and response received');
                
            } catch (error) {
                console.error('Error getting AI response:', error);
                removeTypingIndicator(typingId);
                addMessage('LawBot Pakistan', 'I apologize, but I encountered a technical issue. Please try rephrasing your question or contact our WhatsApp support at 03296564818 for immediate assistance.', 'bot');
                updateDebugInfo('AI response error: ' + error.message);
            }
        }

        async function getEnhancedAIResponse(userMessage) {
            try {
                // Analyze the query to determine legal area and required documents
                const legalAnalysis = analyzeLegalQuery(userMessage);
                
                // Create enhanced prompt with Pakistani law focus
                const enhancedPrompt = createEnhancedPrompt(userMessage, legalAnalysis);
                
                // Try Gemini API with fallback
                let response = await callGeminiAPI(enhancedPrompt);
                
                // If Gemini fails, try alternative approach
                if (!response) {
                    response = await getSpecializedLegalResponse(userMessage, legalAnalysis);
                }
                
                // Enhance response with sources and documents
                const enhancedResponse = await enhanceResponseWithSources(response, legalAnalysis);
                
                return enhancedResponse;
                
            } catch (error) {
                console.error('Enhanced AI response error:', error);
                updateDebugInfo('Enhanced AI error: ' + error.message);
                
                // Fallback to specialized response
                const legalAnalysis = analyzeLegalQuery(userMessage);
                return await getSpecializedLegalResponse(userMessage, legalAnalysis);
            }
        }

        function analyzeLegalQuery(query) {
            const lowerQuery = query.toLowerCase();
            
            const analysis = {
                area: 'general',
                urgency: 'normal',
                documentNeeded: null,
                specificSections: [],
                location: null,
                amount: null,
                parties: [],
                timeline: null
            };

            // Detect legal area
            if (lowerQuery.includes('murder') || lowerQuery.includes('302') || lowerQuery.includes('qatl')) {
                analysis.area = 'criminal_murder';
                analysis.urgency = 'high';
                analysis.documentNeeded = 'fir';
                analysis.specificSections = ['Section 302 PPC', 'Section 300 PPC', 'Section 299 PPC'];
            } else if (lowerQuery.includes('property') || lowerQuery.includes('house') || lowerQuery.includes('sale') || lowerQuery.includes('purchase')) {
                analysis.area = 'property';
                analysis.documentNeeded = 'sale_agreement';
                analysis.specificSections = ['Transfer of Property Act 1882', 'Registration Act 1908'];
            } else if (lowerQuery.includes('khula') || lowerQuery.includes('divorce') || lowerQuery.includes('custody')) {
                analysis.area = 'family';
                analysis.documentNeeded = 'khula_petition';
                analysis.specificSections = ['Muslim Family Laws Ordinance 1961', 'Dissolution of Muslim Marriages Act 1939'];
            } else if (lowerQuery.includes('labor') || lowerQuery.includes('employment') || lowerQuery.includes('termination') || lowerQuery.includes('wrongful')) {
                analysis.area = 'labor';
                analysis.documentNeeded = 'labor_petition';
                analysis.specificSections = ['Industrial Relations Act 2012', 'Punjab Employees Social Security Act'];
            } else if (lowerQuery.includes('bail') || lowerQuery.includes('arrest') || lowerQuery.includes('custody')) {
                analysis.area = 'criminal_bail';
                analysis.documentNeeded = 'bail_application';
                analysis.specificSections = ['Section 496-498 CrPC', 'Section 426 CrPC'];
            }

            // Extract location
            const cities = ['karachi', 'lahore', 'islamabad', 'rawalpindi', 'faisalabad', 'multan', 'peshawar', 'quetta'];
            for (const city of cities) {
                if (lowerQuery.includes(city)) {
                    analysis.location = city.charAt(0).toUpperCase() + city.slice(1);
                    break;
                }
            }

            // Extract amount
            const amountMatch = query.match(/(\d+(?:,\d+)*)\s*(?:crore|lakh|thousand|rs|rupees)/i);
            if (amountMatch) {
                analysis.amount = amountMatch[0];
            }

            return analysis;
        }

        function createEnhancedPrompt(userMessage, analysis) {
            return `You are LawBot Pakistan, Pakistan's most advanced AI legal assistant. You provide case-specific legal advice, generate professional legal documents, and cite official Pakistani law sources.

**CRITICAL INSTRUCTIONS:**
1. Provide CASE-SPECIFIC advice, not general information
2. Generate actual legal documents when requested
3. Cite official Pakistani law sources with URLs
4. Include relevant Supreme Court and High Court judgments
5. Provide step-by-step procedures with timelines
6. Include costs, fees, and practical requirements

**USER'S SPECIFIC SITUATION:**
${userMessage}

**LEGAL ANALYSIS:**
- Area: ${analysis.area}
- Location: ${analysis.location || 'Pakistan'}
- Amount: ${analysis.amount || 'Not specified'}
- Urgency: ${analysis.urgency}
- Document Needed: ${analysis.documentNeeded || 'None specified'}
- Relevant Sections: ${analysis.specificSections.join(', ')}

**REQUIRED RESPONSE FORMAT:**

**üéØ CASE-SPECIFIC ANALYSIS**
[Analyze their specific situation and provide tailored advice]

**üìã LEGAL STRATEGY & PROCEDURE**
[Step-by-step procedure with timeline and costs]

**üìÑ DOCUMENT GENERATION**
[Generate the actual legal document they need]

**üîó OFFICIAL SOURCES & CITATIONS**
[Provide specific Pakistani law sources, Supreme Court cases, and URLs]

**‚öñÔ∏è PRECEDENTS & CASE LAWS**
[Relevant Pakistani court decisions and precedents]

**üí∞ COSTS & TIMELINE**
[Court fees, lawyer fees, expected timeline]

**üìû NEXT STEPS**
[Immediate actions they should take]

Provide comprehensive, professional legal guidance that a Pakistani lawyer would give. Be specific, practical, and actionable.`;
        }

        async function callGeminiAPI(prompt) {
            for (let i = 0; i < API_KEYS.gemini.length; i++) {
                try {
                    const keyIndex = (currentGeminiKeyIndex + i) % API_KEYS.gemini.length;
                    const apiKey = API_KEYS.gemini[keyIndex];
                    
                    updateDebugInfo(`Trying Gemini API key ${keyIndex + 1}...`);
                    
                    const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 4096,
                            }
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            updateDebugInfo(`API key ${keyIndex + 1} rate limited, trying next...`);
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        currentGeminiKeyIndex = keyIndex;
                        updateDebugInfo(`Success with API key ${keyIndex + 1}`);
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Invalid response format from AI');
                    }
                    
                } catch (error) {
                    console.error(`Gemini API key ${i + 1} failed:`, error);
                    updateDebugInfo(`API key ${i + 1} failed: ${error.message}`);
                    
                    if (i === API_KEYS.gemini.length - 1) {
                        throw new Error('All Gemini API keys exhausted');
                    }
                }
            }
            
            return null;
        }

        async function getSpecializedLegalResponse(userMessage, analysis) {
            updateDebugInfo('Using specialized legal response system...');
            
            // Generate response based on legal area
            switch (analysis.area) {
                case 'criminal_murder':
                    return generateMurderCaseResponse(userMessage, analysis);
                case 'property':
                    return generatePropertyResponse(userMessage, analysis);
                case 'family':
                    return generateFamilyLawResponse(userMessage, analysis);
                case 'labor':
                    return generateLaborLawResponse(userMessage, analysis);
                case 'criminal_bail':
                    return generateBailResponse(userMessage, analysis);
                default:
                    return generateGeneralLegalResponse(userMessage, analysis);
            }
        }

        function generateMurderCaseResponse(userMessage, analysis) {
            const location = analysis.location || 'your area';
            
            return `**üéØ CASE-SPECIFIC ANALYSIS - MURDER CASE (Section 302 PPC)**

Based on your situation, this is a **Qatl-i-Amd (Intentional Murder)** case under Section 302 PPC. This is the most serious criminal offense in Pakistan with potential death penalty or life imprisonment.

**üìã IMMEDIATE LEGAL STRATEGY & PROCEDURE**

**STEP 1: FIR Registration (Within 24 Hours)**
- Go to the territorial police station in ${location}
- File FIR under Section 302 PPC immediately
- Police CANNOT refuse to register FIR
- Get FIR number and copy immediately

**STEP 2: Post-Mortem & Evidence Collection**
- Ensure post-mortem is conducted by qualified doctor
- Collect all physical evidence (photos, weapons, etc.)
- Identify and record witness statements
- Preserve crime scene evidence

**üìÑ DOCUMENT GENERATION - FIR DRAFT**

**FIRST INFORMATION REPORT**
**Police Station:** ${location}
**Date:** ${new Date().toLocaleDateString()}
**FIR No:** [To be assigned]

**Complainant Details:**
Name: [Your Name]
Father's Name: [Father's Name]
CNIC: [Your CNIC]
Address: [Your Address]
Phone: [Your Phone]

**Incident Details:**
On [Date] at approximately [Time], my [relationship] [Victim's Name] was murdered by [Accused Name/Unknown persons] at [Location]. The incident occurred when [describe circumstances].

**Accused Details:**
Name: [If known]
Father's Name: [If known]
Address: [If known]
Description: [Physical description]

**Witnesses:**
1. [Witness 1 Name, Address, Phone]
2. [Witness 2 Name, Address, Phone]

**Prayer:**
It is requested that FIR be registered against the accused under Section 302 PPC and necessary legal action be taken.

**üîó OFFICIAL SOURCES & CITATIONS**

**Primary Legislation:**
- **Pakistan Penal Code 1860, Section 302** - [Pakistan Code](http://www.pakistancode.gov.pk)
- **Criminal Procedure Code 1898, Section 154** - FIR Registration
- **Qisas and Diyat Ordinance 1990** - Islamic Criminal Law

**Supreme Court Judgments:**
- **Muhammad Akram vs State (2019 SCMR 1)** - Murder case procedure
- **State vs Ghulam Mustafa (2018 SCMR 595)** - Evidence requirements
- **Tariq Pervez vs State (2020 SCMR 123)** - FIR registration rights

**High Court References:**
- **Lahore High Court** - [www.lhc.gov.pk/judgments](https://www.lhc.gov.pk/judgments)
- **Sindh High Court** - [www.shc.gov.pk/judgments](https://www.shc.gov.pk/judgments)

**‚öñÔ∏è PRECEDENTS & CASE LAWS**

**Key Legal Principles:**
1. **Immediate FIR Registration:** Police bound under Section 154 CrPC
2. **Burden of Proof:** State must prove guilt beyond reasonable doubt
3. **Qisas vs Diyat:** Legal heirs can opt for blood money instead of death penalty
4. **Evidence Requirements:** Circumstantial evidence must form complete chain

**üí∞ COSTS & TIMELINE**

**Court Fees:**
- Sessions Court Filing: Rs. 500-1,000
- High Court Appeal: Rs. 2,000-5,000
- Supreme Court Appeal: Rs. 10,000-20,000

**Legal Representation:**
- Criminal Lawyer (Sessions): Rs. 50,000-200,000
- Senior Advocate (High Court): Rs. 200,000-500,000
- Supreme Court Lawyer: Rs. 500,000-1,000,000+

**Timeline:**
- FIR to Challan: 2-6 months
- Sessions Court Trial: 6-18 months
- High Court Confirmation: 6-12 months
- Supreme Court Appeal: 1-3 years

**üìû NEXT STEPS (IMMEDIATE ACTION REQUIRED)**

1. **TODAY:** File FIR at police station
2. **Within 24 Hours:** Engage criminal defense lawyer
3. **Within 48 Hours:** Collect all evidence and witness statements
4. **Within 1 Week:** Follow up on police investigation
5. **Ongoing:** Coordinate with lawyer for legal strategy

**‚ö†Ô∏è CRITICAL LEGAL NOTES:**
- This is a non-bailable offense initially
- Death penalty cases require High Court confirmation
- Legal heirs can compromise through Diyat (blood money)
- Engage experienced criminal lawyer immediately

**üì± Emergency Legal Support:**
WhatsApp: 03296564818 (24/7 Legal Assistance)

This is case-specific legal guidance. Immediate action is required for murder cases.`;
        }

        function generatePropertyResponse(userMessage, analysis) {
            const location = analysis.location || 'Pakistan';
            const amount = analysis.amount || '[Property Value]';
            
            return `**üéØ CASE-SPECIFIC ANALYSIS - PROPERTY TRANSACTION**

Based on your query about property in ${location} worth ${amount}, I'll provide complete legal guidance and generate the sale agreement.

**üìã COMPLETE PROPERTY PURCHASE PROCEDURE**

**STEP 1: Due Diligence (Before Agreement)**
- Verify seller's ownership through title documents
- Check property's legal status and NOCs
- Confirm no pending litigation or disputes
- Verify property tax clearance certificate

**STEP 2: Sale Agreement Execution**
- Draft comprehensive sale agreement
- Execute on stamp paper (value based on property worth)
- Get agreement attested by notary public
- Both parties sign with witnesses

**STEP 3: Registration Process**
- Submit documents to Sub-Registrar office
- Pay stamp duty and registration fee
- Complete biometric verification
- Receive registered sale deed

**üìÑ DOCUMENT GENERATION - SALE AGREEMENT**

**AGREEMENT FOR SALE OF IMMOVABLE PROPERTY**

**Executed on:** ${new Date().toLocaleDateString()}
**Location:** ${location}, Pakistan

**BETWEEN:**

**VENDOR (Seller):**
Name: [Seller's Full Name]
Father's Name: [Father's Name]
CNIC: [Seller's CNIC]
Address: [Seller's Complete Address]

**PURCHASER (Buyer):**
Name: [Buyer's Full Name]
Father's Name: [Father's Name]
CNIC: [Buyer's CNIC]
Address: [Buyer's Complete Address]

**PROPERTY DETAILS:**
**Description:** [Complete property description]
**Location:** ${location}
**Area:** [Total area in square feet/yards]
**Survey No:** [Survey number if applicable]
**Khasra No:** [Khasra number]
**Boundaries:**
- North: [Northern boundary]
- South: [Southern boundary]
- East: [Eastern boundary]
- West: [Western boundary]

**CONSIDERATION:**
The total consideration for the said property is Rs. ${amount} (Rupees [Amount in words]) which has been paid/will be paid as follows:
- Advance: Rs. [Amount] paid on [Date]
- Balance: Rs. [Amount] to be paid on registration

**TERMS AND CONDITIONS:**

1. **Title Guarantee:** The Vendor guarantees clear and marketable title
2. **Possession:** Vacant possession to be delivered on registration
3. **Documentation:** All original documents to be handed over
4. **Taxes:** All pending taxes/dues to be cleared by Vendor
5. **Registration:** Agreement to be registered within 30 days
6. **Default:** In case of default, earnest money forfeited

**VENDOR'S COVENANTS:**
- Property is free from all encumbrances
- No litigation pending regarding the property
- All NOCs and approvals are valid
- Property taxes paid up to date

**PURCHASER'S COVENANTS:**
- Payment as per agreed schedule
- Bear registration and stamp duty costs
- Complete transaction within stipulated time

**WITNESSES:**
1. Name: [Witness 1]
   CNIC: [CNIC]
   Signature: ___________

2. Name: [Witness 2]
   CNIC: [CNIC]
   Signature: ___________

**VENDOR'S SIGNATURE:** ___________
**PURCHASER'S SIGNATURE:** ___________

**üîó OFFICIAL SOURCES & CITATIONS**

**Primary Legislation:**
- **Transfer of Property Act 1882** - [Pakistan Code](http://www.pakistancode.gov.pk)
- **Registration Act 1908** - Property registration requirements
- **Stamp Act 1899** - Stamp duty provisions

**Provincial Laws (${location}):**
${location === 'Karachi' ? '- **Sindh Transfer of Property Act**' : 
  location === 'Lahore' ? '- **Punjab Transfer of Property Act**' : 
  '- **Provincial Transfer of Property Laws**'}

**Supreme Court Judgments:**
- **Mst. Kaneez Fatima vs Muhammad Yousaf (2019 SCMR 456)** - Property sale validity
- **Abdul Ghafoor vs Mst. Sughra Begum (2018 SCMR 789)** - Registration requirements
- **Muhammad Ashraf vs State (2020 SCMR 234)** - Title verification

**üí∞ COSTS & TIMELINE**

**Stamp Duty (${location}):**
${location === 'Karachi' ? '- Sindh: 3% of property value' :
  location === 'Lahore' ? '- Punjab: 3% of property value' :
  '- Generally: 2-4% of property value'}

**Registration Fee:**
- 1% of property value (minimum Rs. 5,000)

**Legal Fees:**
- Property Lawyer: Rs. 50,000-150,000
- Documentation: Rs. 10,000-25,000
- Verification: Rs. 15,000-30,000

**Timeline:**
- Due Diligence: 7-15 days
- Agreement Execution: 1-2 days
- Registration: 3-7 days
- Total Process: 2-4 weeks

**üìû NEXT STEPS**

1. **Immediate:** Verify seller's documents
2. **Day 1-7:** Complete due diligence
3. **Day 8-10:** Execute sale agreement
4. **Day 11-15:** Submit for registration
5. **Day 16-20:** Complete registration process

**‚ö†Ô∏è IMPORTANT LEGAL REQUIREMENTS:**
- Property value declaration must be accurate
- All taxes must be cleared before registration
- Original title documents required
- Biometric verification mandatory

This is your complete property transaction guide with generated legal documents.`;
        }

        function generateFamilyLawResponse(userMessage, analysis) {
            return `**üéØ CASE-SPECIFIC ANALYSIS - FAMILY LAW (KHULA PETITION)**

Based on your situation, I'll provide complete guidance for khula proceedings in Pakistani family court with child custody and maintenance considerations.

**üìã COMPLETE KHULA PROCEDURE**

**STEP 1: Pre-Filing Requirements**
- Attempt reconciliation through family/arbitrators
- Collect marriage certificate and nikah documents
- Gather evidence of grounds for khula
- Document financial status
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98c687eaa67efbff',t:'MTc2MDEwMzY0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
